# TODO: commented part works great. But the problem is that I didn't
# find a way to use hibernate in Ubuntu 24.04 without hardware support from
# ACPI yet.

- name: Find encrypted swap partition UUID
  command: lsblk -f -o NAME,UUID,MOUNTPOINTS
  register: lsblk_output

- name: Get lsblk output
  command: lsblk -f -o NAME,UUID,MOUNTPOINTS
  register: lsblk_output

- name: Debug lsblk output
  debug:
    msg: "{{ lsblk_output.stdout_lines }}"

- name: Set swap UUID variable to none (initially)
  set_fact:
    swap_uuid: null

- name: Process lsblk output and extract swap UUID using regex
  set_fact:
    swap_uuid: "{{ item | regex_search('([a-f0-9-]{36})') }}"
  loop: "{{ lsblk_output.stdout_lines }}"
  when: "'[SWAP]' in item"
  vars:
    swap_uuid: null
  until: swap_uuid is not none

- name: Debug swap UUID1
  debug:
    msg: "{{ swap_uuid }}"

- name: Update GRUB with resume parameter
  lineinfile:
    path: /etc/default/grub
    regexp: ^GRUB_CMDLINE_LINUX_DEFAULT=
    line: 'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash resume=UUID={{ swap_uuid }}"'
    backup: true

- name: Update initramfs resume configuration
  copy:
    dest: /etc/initramfs-tools/conf.d/resume
    content: |
      RESUME=UUID={{ swap_uuid }}
    owner: root
    group: root
    mode: "0644"

- name: Update GRUB
  command: update-grub

- name: Update initramfs
  command: update-initramfs -u

- name: Check ACPI support for power modes
  shell: dmesg | grep -i acpi | grep -i "supports s"
  register: acpi_sleep_state
  changed_when: false
  ignore_errors: true # In case no ACPI sleep states are found, don't fail

- name: Debug ACPI sleep state output
  debug:
    msg: "{{ acpi_sleep_state.stdout }}"

# - name: Include tasks for systems without ACPI S4 support
#   include_tasks: without_acpi_s4.yml
#   when: "'S4' not in acpi_sleep_state.stdout"

# - name: Include tasks for systems with ACPI S4 support
#   include_tasks: with_acpi_s4.yml
#   when: "'S4' in acpi_sleep_state.stdout"
