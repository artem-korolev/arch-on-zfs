---
- name: Generate key file for swap encryption
  ansible.builtin.command: dd if=/dev/urandom of=/root/swap_keyfile bs=512 count=4
  args:
    creates: /root/swap_keyfile

- name: Set permissions on the key file
  ansible.builtin.file:
    path: /root/swap_keyfile
    mode: "0600"
    owner: root
    group: root

- name: Replace the crypttab entry with a keyfile-based swap configuration
  ansible.builtin.lineinfile:
    path: /etc/crypttab
    regexp: ^.*(swap.*urandom|urandom.*swap).*$
    line: dm_crypt-0 {{ crypttab_uuid.stdout }} /root/swap_keyfile swap,initramfs
    state: present
    backrefs: true
    backup: true

- name: Regenerate initramfs
  ansible.builtin.command: update-initramfs -u
  changed_when: true
