---
- name: Extract UUID from current crypttab configuration
  ansible.builtin.shell: |
    set -o pipefail
    grep -m 1 -E 'swap.*urandom|urandom.*swap' /etc/crypttab | awk '{print $2}'
  args:
    executable: /bin/bash
  register: crypttab_uuid
  changed_when: true
  ignore_errors: true

- name: Check if UUID was found and proceed if valid
  ansible.builtin.debug:
    msg: "UUID found: {{ crypttab_uuid.stdout }}"
  when: crypttab_uuid.stdout != ""

- name: Proceed with swap and hibernate configuration
  when: crypttab_uuid.stdout != ""
  block:
    - name: Include swap reconfiguration tasks
      ansible.builtin.include_tasks: configure_swap.yml

    - name: Include hibernate configuration tasks
      ansible.builtin.include_tasks: enable_hibernate.yml

    - name: Reboot the system using systemctl
      ansible.builtin.command: systemctl reboot
      async: 1
      poll: 0
      changed_when: true
      # noqa: command-instead-of-module
  rescue:
    - name: Handle failure during swap reconfiguration
      ansible.builtin.debug:
        msg: Swap reconfiguration / enabling hibernate failed

- name: Swap is not using urandom, so no need to configure it, but maybe Hibernate is not configured yet
  when: crypttab_uuid.stdout == ""
  block:
    - name: Include hibernate configuration tasks
      ansible.builtin.include_tasks: enable_hibernate.yml
  rescue:
    - name: Handle failure during swap reconfiguration
      ansible.builtin.debug:
        msg: >
          If you run this task second time, then no need to do anything,
          otherwise reboot system manually to get Hibernate configured
