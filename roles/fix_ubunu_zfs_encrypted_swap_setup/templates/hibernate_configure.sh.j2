#!/usr/bin/env bash
set -e

# Extract swap UUID
swap_uuid=$(lsblk -f -o UUID,MOUNTPOINTS | awk '/\[SWAP\]/ {print $1}')

# Check if UUID is already configured in GRUB and resume file
if grep -q "$swap_uuid" /etc/default/grub && [ -f /etc/initramfs-tools/conf.d/resume ] && grep -q "$swap_uuid" /etc/initramfs-tools/conf.d/resume; then
    echo "Hibernate is already configured. No action on it."
    exit 0
fi

# Update GRUB with resume parameter safely
current_cmdline=$(grep "^GRUB_CMDLINE_LINUX_DEFAULT=" /etc/default/grub | cut -d'"' -f2)
new_cmdline="$current_cmdline resume=UUID=$swap_uuid"
sed -i "s|^GRUB_CMDLINE_LINUX_DEFAULT=.*|GRUB_CMDLINE_LINUX_DEFAULT=\"$new_cmdline\"|" /etc/default/grub || {
    echo "Failed to update GRUB configuration"
    exit 1
}
# Update GRUB
update-grub

# Update initramfs resume configuration
echo "RESUME=UUID=$swap_uuid" > /etc/initramfs-tools/conf.d/resume
update-initramfs -u

echo "Hibernate is configured now. Let's reboot the system to apply configurations"
# Reboot the system
reboot
